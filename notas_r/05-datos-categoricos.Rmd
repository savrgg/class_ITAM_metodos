---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidymodels)
library(readr)
library(gridExtra)

datos <- read_csv("https://raw.githubusercontent.com/savrgg/class_ITAM_metodos/main/notas_r/train.csv")

datos_o <- 
  datos %>% 
  mutate(
    Survived_prev = Survived,
    Survived = factor(Survived, labels = c("No Sobrevivió", "Sobrevivió")),
         Age = case_when(
           Age < 3 ~ "[0-03) \n Bebés",
           Age < 10 ~ "[03-10) \n Niños/Niñas",
           Age < 18 ~ "[10-18) \n Adolescentes",
           Age < 30 ~ "[18-30) \n Adultos Jóvenes",
           Age < 45 ~ "[30-45) \n Adultos Media",
           Age < 65 ~ "[45-65) \n Adultos Maduros",
           Age < 120 ~ "[65+) \n Tercera Edad",
           TRUE ~ "No proporcionado"
           ),
         Title = gsub('(.*, )|(\\..*)', '', Name))

plot_general <- function(var_p){
  datos_o %>% 
  ggplot(aes(x = factor(!!sym(var_p)), fill = Survived))+
  geom_bar()+
  geom_text(aes(label = after_stat(count)), 
            stat = "count", position = position_stack(), vjust = 1, color = "gray50", size = 2)+
  scale_fill_brewer(palette = "Greens")+
  theme_minimal()+
  theme(legend.position = "bottom", text = element_text(size = 5))+
  labs(
    x = "",
    y = "Número de sobrevivientes",
    title = "Número de sobrevivientes en Titanic",
    subtitle = "891 pasajeros, 38.4% Sobreviven",
    caption = "Base extraída de: kaggle.com/competitions/titanic",
    fill = ""
  )  
}

plot_general_norm <- function(var_p){
  datos_o %>% 
  ggplot(aes(x = factor(!!sym(var_p)), fill = Survived))+
  geom_bar(position = "fill", aes(fill = Survived))+
  geom_text(aes(label = scales::percent(after_stat(count/tapply(count, x, sum)[x])), group = Survived), 
            stat = "count", position = position_fill(), vjust = 2, color = "gray50", size = 2)+
  scale_fill_brewer(palette = "Greens")+
  theme_minimal()+
  scale_y_continuous(labels = percent_format())+
  theme(legend.position = "bottom", text = element_text(size = 6))+
  labs(
    x = "",
    y = "Porcentaje de sobrevivientes",
    title = "Porcentaje de sobrevivientes en Titanic",
    subtitle = "891 pasajeros, 38.4% Sobreviven",
    caption = "Base extraída de: kaggle.com/competitions/titanic",
    fill = ""
  )
}

datos
```

```{r}
var_p <- "Sex"
grid.arrange(
  plot_general(var_p),
  plot_general_norm(var_p), ncol = 2
)

```
```{r}
lm_model <- 
  linear_reg() %>% 
  fit(Survived_prev ~ Sex, data = datos_o)

tidy(lm_model)
glance(lm_model)

datos_o %>% 
  group_by(Sex) %>% 
  summarise(porc_survived = sum(Survived_prev)/n())
```



```{r}
var_p <- "Pclass"
grid.arrange(
  plot_general(var_p),
  plot_general_norm(var_p), ncol = 2
)

```



```{r}
lm_model <- 
  linear_reg() %>% 
  fit(Survived_prev  ~ factor(Pclass), data = datos_o)

tidy(lm_model)
glance(lm_model)

datos_o %>% 
  group_by(Pclass) %>% 
  summarise(porc_survived = sum(Survived_prev)/n())
```


```{r}
var_p <- "Age"
plot_general(var_p)
plot_general_norm(var_p)
```
```{r}
lm_model <- 
  linear_reg() %>% 
  fit(Survived_prev  ~ Age, data = datos_o)

tidy(lm_model)
glance(lm_model)

datos_o %>% 
  group_by(Age) %>% 
  summarise(porc_survived = sum(Survived_prev)/n())
```


```{r}
var_p <- "Title"
plot_general(var_p)
plot_general_norm(var_p)
```

```{r}
lm_model <- 
  linear_reg() %>% 
  fit(Survived_prev  ~ Title, data = datos_o)

tidy(lm_model)
glance(lm_model)

datos_o %>% 
  group_by(Title) %>% 
  summarise(porc_survived = sum(Survived_prev)/n())
```



```{r}
lm_model <- 
  linear_reg() %>% 
  fit(Survived_prev  ~ Sex+factor(Pclass)+Age, data = datos_o)

tidy(lm_model)
glance(lm_model)

datos_o %>% 
  group_by(Sex, Pclass, Age) %>% 
  summarise(porc_survived = sum(Survived_prev)/n()) %>% 
  arrange(desc(porc_survived)) %>% data.frame() %>% 
  filter(Sex == "male", Pclass == 2, Age == "[45-65) \n Adultos Maduros")
```


